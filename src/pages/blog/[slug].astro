---
import BlogLayout from '@layouts/BlogLayout.astro';
import SchemaOrg from '@components/aeo/SchemaOrg.astro';
import TLDRBox from '@components/aeo/TLDRBox.astro';
import FAQSection from '@components/aeo/FAQSection.astro';
import CompareTable from '@components/aeo/CompareTable.astro';
import UpdateDate from '@components/common/UpdateDate.astro';
import { getAllPosts, getRelatedPosts } from '@data/blog';
import { articleSchema, faqSchema } from '@lib/schema';
import { formatDateKo } from '@lib/utils';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

if (!post) {
  return Astro.redirect('/blog');
}

const related = await getRelatedPosts(post);

const rfCompareHeaders = ['단일 에너지 (기존)', '복합 다중 에너지 (BRITZMEDI)'];
const rfCompareRows = [
  { label: '접근 방식', values: ['출력 증가로 효과 극대화', '에너지 조합 구조 재설계로 효율 극대화'] },
  { label: '출력 수준', values: ['고출력 필요', '저출력으로 동등한 효과'] },
  { label: '시술자 숙련도 의존도', values: ['높음 (결과 편차 발생)', '낮음 (재현성·안정성 확보)'] },
  { label: '안전성', values: ['고출력에 따른 부작용 위험', '저출력 구조로 높은 안전성'] },
  { label: '적응증 범위', values: ['단일 에너지 한계', '복합 적응증 대응 가능'] },
  { label: '대표 기기', values: ['기존 모노폴라/바이폴라 RF', 'TORR RF (BRITZMEDI)'] },
];
---

<BlogLayout
  title={post.title}
  description={post.excerpt}
  author={post.author}
  publishedAt={post.publishedAt}
  category={post.categoryLabel}
>
  <SchemaOrg
    schema={[
      articleSchema({
        title: post.title,
        description: post.excerpt,
        slug: post.slug,
        author: post.author,
        datePublished: post.publishedAt,
      }),
      faqSchema(post.faqs),
    ]}
    slot="head"
  />

  <!-- TL;DR -->
  <TLDRBox content={post.excerpt} />

  <!-- 본문 콘텐츠 -->
  <div class="prose prose-lg max-w-none my-10 text-zinc-600 leading-relaxed [&>h2]:mt-12 [&>h2]:mb-4 [&>h2]:text-2xl [&>h2]:font-bold [&>h2]:text-zinc-900 [&>p]:mb-5 [&>blockquote]:border-l-2 [&>blockquote]:border-zinc-300 [&>blockquote]:pl-6 [&>blockquote]:text-zinc-500 [&>blockquote]:italic [&>blockquote]:my-8">
    <Fragment set:html={post.content} />
  </div>

  <!-- RF 비교표 (rf-guide 카테고리만) -->
  {post.category === 'rf-guide' && (
    <section class="my-12">
      <h2 class="mb-6 text-2xl font-bold text-zinc-900">RF 방식별 비교표</h2>
      <CompareTable headers={rfCompareHeaders} rows={rfCompareRows} highlight={1} />
    </section>
  )}

  <!-- FAQ -->
  <FAQSection items={post.faqs} />

  <!-- 관련 제품 -->
  {post.relatedProducts.length > 0 && (
    <section class="my-12">
      <h2 class="mb-6 text-2xl font-bold text-zinc-900">관련 제품</h2>
      <div class="flex flex-wrap gap-3">
        {post.relatedProducts.map((product) => (
          <a
            href={product.href}
            class="rounded-lg border border-zinc-200 px-5 py-3 font-semibold text-zinc-900 transition-colors hover:border-teal-500 hover:text-teal-600"
          >
            {product.title}
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- 관련 아티클 (APR 스타일 카드) -->
  {related.length > 0 && (
    <section class="mt-16 border-t border-zinc-100 pt-12">
      <h2 class="mb-8 text-2xl font-bold text-zinc-900">관련 아티클</h2>
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {related.map((r) => (
          <a href={`/blog/${r.slug}`} class="group">
            <div class="mb-3 flex h-40 items-center justify-center rounded-xl bg-zinc-100 transition-colors group-hover:bg-zinc-200">
              <svg class="h-8 w-8 text-zinc-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
            </div>
            <p class="text-xs text-zinc-400">{formatDateKo(r.publishedAt)}</p>
            <h3 class="mt-1 font-semibold text-zinc-900 transition-colors group-hover:text-teal-600 leading-snug">
              {r.title}
            </h3>
          </a>
        ))}
      </div>
    </section>
  )}

  <UpdateDate date={post.publishedAt} />
</BlogLayout>
