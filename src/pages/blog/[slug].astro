---
import BlogLayout from '@layouts/BlogLayout.astro';
import SchemaOrg from '@components/aeo/SchemaOrg.astro';
import TLDRBox from '@components/aeo/TLDRBox.astro';
import FAQSection from '@components/aeo/FAQSection.astro';
import CompareTable from '@components/aeo/CompareTable.astro';
import UpdateDate from '@components/common/UpdateDate.astro';
import { getAllPosts, getPostBySlug, getRelatedPosts } from '@data/blog';
import { articleSchema, faqSchema } from '@lib/schema';
import { formatDateKo } from '@lib/utils';

export function getStaticPaths() {
  const posts = getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect('/blog');
}

const related = getRelatedPosts(post);

const rfCompareHeaders = ['모노폴라 RF', '바이폴라 RF', '토로이달 RF'];
const rfCompareRows = [
  { label: '에너지 전달', values: ['단방향 (깊은 침투)', '양극 사이 (얕은 침투)', '360도 균일 전달'] },
  { label: '침투 깊이', values: ['진피~피하지방', '표피~진피 상부', '표피~피하지방 (Multi-wave)'] },
  { label: '핫스팟 위험', values: ['높음', '낮음', '없음 (자동 출력 제어)'] },
  { label: '접지 패드', values: ['필요', '불필요', '불필요'] },
  { label: '대표 장비', values: ['써마지(Thermage)', '다수 소형 RF', 'TORR RF'] },
  { label: 'FDA 승인', values: ['있음', '장비별 상이', '있음'] },
];
---

<BlogLayout
  title={post.title}
  description={post.excerpt}
  author={post.author}
  publishedAt={post.publishedAt}
  category={post.categoryLabel}
>
  <SchemaOrg
    schema={[
      articleSchema({
        title: post.title,
        description: post.excerpt,
        slug: post.slug,
        author: post.author,
        datePublished: post.publishedAt,
      }),
      faqSchema(post.faqs),
    ]}
    slot="head"
  />

  <!-- TL;DR -->
  <TLDRBox content={post.excerpt} />

  <!-- 본문 콘텐츠 -->
  <div class="prose prose-lg max-w-none my-10 text-zinc-600 leading-relaxed [&>h2]:mt-12 [&>h2]:mb-4 [&>h2]:text-2xl [&>h2]:font-bold [&>h2]:text-zinc-900 [&>p]:mb-5 [&>blockquote]:border-l-2 [&>blockquote]:border-zinc-300 [&>blockquote]:pl-6 [&>blockquote]:text-zinc-500 [&>blockquote]:italic [&>blockquote]:my-8">
    <Fragment set:html={post.content} />
  </div>

  <!-- RF 비교표 (rf-guide 카테고리만) -->
  {post.category === 'rf-guide' && (
    <section class="my-12">
      <h2 class="mb-6 text-2xl font-bold text-zinc-900">RF 방식별 비교표</h2>
      <CompareTable headers={rfCompareHeaders} rows={rfCompareRows} highlight={2} />
    </section>
  )}

  <!-- FAQ -->
  <FAQSection items={post.faqs} />

  <!-- 관련 제품 -->
  {post.relatedProducts.length > 0 && (
    <section class="my-12">
      <h2 class="mb-6 text-2xl font-bold text-zinc-900">관련 제품</h2>
      <div class="flex flex-wrap gap-3">
        {post.relatedProducts.map((product) => (
          <a
            href={product.href}
            class="rounded-lg border border-zinc-200 px-5 py-3 font-semibold text-zinc-900 transition-colors hover:border-zinc-400 hover:text-zinc-400"
          >
            {product.title}
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- 관련 아티클 (APR 스타일 카드) -->
  {related.length > 0 && (
    <section class="mt-16 border-t border-zinc-100 pt-12">
      <h2 class="mb-8 text-2xl font-bold text-zinc-900">관련 아티클</h2>
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {related.map((r) => (
          <a href={`/blog/${r.slug}`} class="group">
            <div class="mb-3 flex h-40 items-center justify-center rounded-xl bg-zinc-100 transition-colors group-hover:bg-zinc-200">
              <svg class="h-8 w-8 text-zinc-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
            </div>
            <p class="text-xs text-zinc-400">{formatDateKo(r.publishedAt)}</p>
            <h3 class="mt-1 font-semibold text-zinc-900 transition-colors group-hover:text-zinc-500 leading-snug">
              {r.title}
            </h3>
          </a>
        ))}
      </div>
    </section>
  )}

  <UpdateDate date={post.publishedAt} />
</BlogLayout>
